<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutritional Insights - Secure Application</title>
    <!-- Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.0/dist/tailwind.min.css" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Plotly.js CDN for animated charts -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Papa Parse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100">

    <!-- Login Section (Shown when not authenticated) -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Nutritional Insights</h1>
                <p class="text-gray-600">Secure Cloud-Native Application</p>
            </div>

            <!-- OAuth Login Buttons -->
            <div class="space-y-4 mb-6">
                <button onclick="authManager.loginWithGoogle()" 
                        class="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-50 flex items-center justify-center transition">
                    <svg class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Continue with Google
                </button>

                <button onclick="authManager.loginWithGitHub()" 
                        class="w-full bg-gray-800 text-white py-3 px-4 rounded-lg hover:bg-gray-900 flex items-center justify-center transition">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    Continue with GitHub
                </button>
            </div>

            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">Or continue with email</span>
                </div>
            </div>

            <!-- Email Login Form -->
            <form id="emailLoginForm" onsubmit="handleEmailLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition font-medium">
                    Sign In
                </button>
            </form>

            <div class="mt-6 text-center">
                <button onclick="showSignupForm()" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                    Don't have an account? Sign up
                </button>
            </div>

            <!-- Security Badge -->
            <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                <p class="text-xs text-gray-500 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                    </svg>
                    Secured with Firebase Authentication & AES-256 Encryption
                </p>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Create Account</h2>
            <form id="signupForm" onsubmit="handleSignup(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="signupName" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="signupEmail" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="signupPassword" required minlength="6"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition font-medium">
                    Create Account
                </button>
                <button type="button" onclick="hideSignupForm()" 
                        class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
            </form>
        </div>
    </div>

    <!-- 2FA QR Code Modal -->
    <div id="qrCodeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Enable Two-Factor Authentication</h2>
            <p class="text-gray-600 mb-4">Scan this QR code with Google Authenticator or Authy:</p>
            <div class="flex justify-center mb-4">
                <img id="qrCodeImage" src="" alt="2FA QR Code" class="w-48 h-48">
            </div>
            <p class="text-sm text-gray-600 mb-2">Or enter this secret key manually:</p>
            <p id="secretKey" class="font-mono text-sm bg-gray-100 p-2 rounded mb-4"></p>
            <button onclick="document.getElementById('qrCodeModal').classList.add('hidden')" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                Done
            </button>
        </div>
    </div>

    <!-- Main Application (Shown when authenticated) -->
    <div id="mainContent" class="hidden">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <h2 class="text-xl font-semibold mb-2">Loading Data from CSV...</h2>
                <p class="text-gray-600" id="loadingStatus">Fetching All_Diets.csv from Kaggle dataset</p>
            </div>
        </div>

        <!-- Header with User Info -->
        <header class="bg-blue-600 p-4 text-white">
            <div class="container mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-semibold">Nutritional Insights</h1>
                    <p class="text-sm mt-1">Secure Cloud-Native Application</p>
                </div>
                <div id="userInfo" class="text-right">
                    <!-- User info will be populated by auth-manager.js -->
                </div>
            </div>
        </header>

        <main class="container mx-auto p-6">
            <!-- User Role Badge -->
            <section class="mb-6">
                <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-gray-800">Your Role</h3>
                        <p class="text-sm text-gray-600">Access level and permissions</p>
                    </div>
                    <span id="userRoleBadge" class="px-4 py-2 rounded-full text-white text-sm font-semibold">
                        Loading...
                    </span>
                </div>
            </section>

            <!-- Security Dashboard -->
            <section class="mb-8 bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="font-semibold text-green-800 mb-3">Security Status</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-green-700">Authenticated</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-green-700">Session Active</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-green-700" id="2faStatus">2FA: Disabled</span>
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="authManager.enable2FA()" 
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
                        Enable 2FA
                    </button>
                </div>
            </section>

            <!-- Data Source Info -->
            <section class="mb-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-800 mb-2">ðŸ“Š Data Source</h3>
                <p class="text-sm text-blue-700" id="dataSourceInfo">Loading from: All_Diets.csv</p>
                <p class="text-xs text-blue-600 mt-1" id="recordCount">Processing records...</p>
            </section>

            <!-- Filter Results Summary -->
            <section class="mb-6" id="filterSummary" style="display: none;">
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 border-blue-600 p-4 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-700">Filtered Results</p>
                            <p class="text-lg font-bold text-blue-600" id="filterResultCount">0 diet types match your filters</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-600">Showing</p>
                            <p class="text-sm font-semibold text-gray-800" id="nutrientFocusDisplay">All Nutrients</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Explore Nutritional Insights -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Explore Nutritional Insights</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 shadow-lg rounded-lg">
                        <h3 class="font-semibold">Bar Chart <span class="text-xs text-blue-500">(Plotly.js)</span></h3>
                        <p class="text-sm text-gray-600">Average macronutrient content by diet type.</p>
                        <div id="barChart" style="width: 100%; height: 250px;"></div>
                    </div>

                    <div class="bg-white p-4 shadow-lg rounded-lg">
                        <h3 class="font-semibold">Scatter Plot <span class="text-xs text-blue-500">(Plotly.js)</span></h3>
                        <p class="text-sm text-gray-600">Nutrient relationships (protein vs carbs).</p>
                        <div id="scatterPlot" style="width: 100%; height: 250px;"></div>
                    </div>

                    <div class="bg-white p-4 shadow-lg rounded-lg">
                        <h3 class="font-semibold">Heatmap <span class="text-xs text-blue-500">(Plotly.js)</span></h3>
                        <p class="text-sm text-gray-600">Nutrient correlations.</p>
                        <div id="heatmap" style="width: 100%; height: 250px;"></div>
                    </div>

                    <div class="bg-white p-4 shadow-lg rounded-lg">
                        <h3 class="font-semibold">Pie Chart <span class="text-xs text-green-500">(Chart.js)</span></h3>
                        <p class="text-sm text-gray-600">Recipe distribution by diet type.</p>
                        <div style="position: relative; height: 200px; width: 100%;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Enhanced Filters -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Advanced Filters and Data Interaction</h2>
                <div class="bg-white p-6 shadow-lg rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <!-- Diet Type Filter -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Filter by Diet Type</label>
                            <select id="dietSelect" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Diet Types</option>
                                <option value="vegan">Vegan</option>
                                <option value="keto">Keto</option>
                                <option value="paleo">Paleo</option>
                                <option value="mediterranean">Mediterranean</option>
                                <option value="dash">Dash</option>
                            </select>
                        </div>

                        <!-- Nutrient Focus Filter -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Focus on Nutrient</label>
                            <select id="nutrientSelect" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Nutrients</option>
                                <option value="protein">Protein Only</option>
                                <option value="carbs">Carbs Only</option>
                                <option value="fat">Fat Only</option>
                            </select>
                        </div>

                        <!-- Sort By Filter -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Sort By</label>
                            <select id="sortSelect" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <option value="name">Diet Name (A-Z)</option>
                                <option value="protein-high">Highest Protein</option>
                                <option value="protein-low">Lowest Protein</option>
                                <option value="carbs-high">Highest Carbs</option>
                                <option value="carbs-low">Lowest Carbs</option>
                                <option value="fat-high">Highest Fat</option>
                                <option value="fat-low">Lowest Fat</option>
                            </select>
                        </div>
                    </div>

                    <!-- Range Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <!-- Protein Range -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Protein Range: <span id="proteinRangeLabel">0g - 200g</span>
                            </label>
                            <input type="range" id="proteinRange" min="0" max="200" value="200" 
                                   class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Carbs Range -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Carbs Range: <span id="carbsRangeLabel">0g - 300g</span>
                            </label>
                            <input type="range" id="carbsRange" min="0" max="300" value="300" 
                                   class="w-full h-2 bg-green-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Fat Range -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Fat Range: <span id="fatRangeLabel">0g - 200g</span>
                            </label>
                            <input type="range" id="fatRange" min="0" max="200" value="200" 
                                   class="w-full h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="applyFilters()" 
                                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                            Apply Filters
                        </button>
                        <button onclick="resetFilters()" 
                                class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500 transition">
                            Reset All
                        </button>
                    </div>

                    <!-- Active Filters Display -->
                    <div id="activeFilters" class="mt-4 hidden">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Active Filters:</p>
                        <div id="filterTags" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </section>

            <!-- API Data Interaction -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">API Data Interaction</h2>
                <div class="flex flex-wrap gap-4 mb-4">
                    <button onclick="getNutritionalInsights()" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition">
                        Get Nutritional Insights
                    </button>
                    <button onclick="getRecipes()" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 transition">
                        Get Recipes
                    </button>
                    <button onclick="getClusters()" class="bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 transition">
                        Get Clusters
                    </button>
                </div>
                
                <!-- API Results Display -->
                <div id="apiResults" class="hidden bg-white p-6 rounded-lg shadow-lg border-2 border-blue-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800" id="apiResultsTitle">Results</h3>
                        <button onclick="closeApiResults()" class="text-gray-500 hover:text-gray-700 font-bold text-xl">
                            Ã—
                        </button>
                    </div>
                    <div id="apiResultsContent" class="text-gray-700">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </div>
            </section>

            <!-- Security & Compliance -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Security & Compliance</h2>
                <div class="bg-white p-4 shadow-lg rounded-lg">
                    <h3 class="font-semibold mb-3">Security Status</h3>
                    <p class="text-sm text-gray-600 mb-1">Encryption: <span id="encryptionStatusSimple" class="font-semibold text-green-600">Checking...</span></p>
                    <p class="text-sm text-gray-600 mb-1">Access Control: <span id="accessControlStatusSimple" class="font-semibold text-green-600">Checking...</span></p>
                    <p class="text-sm text-gray-600 mb-1">2FA Status: <span id="twoFactorStatusSimple" class="font-semibold text-yellow-600">Checking...</span></p>
                    <p class="text-sm text-gray-600 mb-3">Compliance: <span class="font-semibold text-green-600">GDPR Compliant</span></p>
                    
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <button onclick="refreshSecurityStatus()" 
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm mr-2">
                            Refresh Status
                        </button>
                        <button onclick="downloadSecurityReport()" 
                                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
                            Download Report
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-3">Last updated: <span id="lastSecurityCheck">Just now</span></p>
                </div>
            </section>

            <!-- OAuth & 2FA Integration -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">OAuth & 2FA Integration</h2>
                <div class="bg-white p-4 shadow-lg rounded-lg">
                    <h3 class="font-semibold mb-4">Secure Login</h3>
                    <button onclick="handleOAuthLogin('google')" class="bg-blue-600 text-white py-2 px-4 rounded mb-4 hover:bg-blue-700">
                        Login with Google
                    </button>
                    <button onclick="handleOAuthLogin('github')" class="bg-blue-600 text-white py-2 px-4 rounded mb-4 ml-2 hover:bg-blue-700">
                        Login with GitHub
                    </button>
                    <div class="mt-4">
                        <label for="twoFactorCode" class="block text-sm text-gray-600 mb-2">Enter 2FA Code</label>
                        <input 
                            id="twoFactorCode" 
                            type="text" 
                            maxlength="6"
                            pattern="[0-9]{6}"
                            class="p-2 border rounded w-full mb-2" 
                            placeholder="Enter your 2FA code">
                        <button onclick="verify2FACodeSimple()" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                            Verify Code
                        </button>
                        <div id="2faVerifyStatus" class="hidden mt-3 p-3 rounded text-sm"></div>
                    </div>
                </div>
            </section>

            <!-- Cloud Resource Cleanup -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Cloud Resource Cleanup</h2>
                <div class="bg-white p-4 shadow-lg rounded-lg">
                    <p class="text-sm text-gray-600 mb-4">Ensure that cloud resources are efficiently managed and cleaned up post-deployment.</p>
                    <button onclick="initiateCleanup()" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
                        Clean Up Resources
                    </button>
                    
                    <!-- Cleanup Status Display -->
                    <div id="cleanupStatus" class="hidden mt-4 p-4 rounded-lg border">
                        <h4 class="font-semibold mb-2" id="cleanupStatusTitle">Cleanup Status</h4>
                        <div id="cleanupProgress" class="space-y-2"></div>
                    </div>
                </div>
            </section>

            <!-- Data Table -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Data Table</h2>
                <div class="bg-white p-4 shadow-lg rounded-lg overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-4 py-2 text-left">Diet Type</th>
                                <th class="px-4 py-2 text-left">Protein (g)</th>
                                <th class="px-4 py-2 text-left">Carbs (g)</th>
                                <th class="px-4 py-2 text-left">Fat (g)</th>
                                <th class="px-4 py-2 text-left">Recipes</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-center gap-2 mt-4" id="paginationControls">
                </div>
            </section>

            <!-- Audit Logs (Admin Only) -->
            <section class="mb-8" data-require-permission="view_audit_logs">
                <h2 class="text-2xl font-semibold mb-4">Audit Logs</h2>
                <div class="bg-white p-4 shadow-lg rounded-lg">
                    <button onclick="loadAuditLogs()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 mb-4">
                        Load Recent Logs
                    </button>
                    <div id="auditLogsList" class="space-y-2">
                        <p class="text-gray-500 text-sm">Click "Load Recent Logs" to view audit trail</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-blue-600 p-4 text-white text-center mt-10">
            <p>&copy; 2025 Nutritional Insights. All Rights Reserved.</p>
            <p class="mt-2 font-semibold">Group 7</p>
            <p class="mt-1">Annie Â· Komalpreet Â· Rhailyn Jane</p>
        </footer>
    </div>

    <!-- Load Security Modules in Order -->
    <script src="firebase-config.js"></script>
    <script src="audit-logger.js"></script>
    <script src="encryption-utils.js"></script>
    <script src="rbac-manager.js"></script>
    <script src="auth-manager.js"></script>

    <!-- Application Logic -->
    <script>
        // ============================================
        // AZURE API CONFIGURATION
        // ============================================
        // TODO: Replace with your Azure Function App URL after deployment
        const API_BASE_URL = 'https://nutritionalinsights-api1.azurewebsites.net/api';

        // Set to true to use Azure API, false to use local CSV data
        const USE_AZURE_API = true;

        // Global variables
        let dietTypesData = [];
        let topProteinRecipes = [];
        let rawCSVData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 3;
        let barChart, scatterChart, pieChart;

        // Global filter state
        let currentFilters = {
            dietType: 'all',
            nutrient: 'all',
            sort: 'name',
            proteinMax: 200,
            carbsMax: 300,
            fatMax: 200
        };

        // Form handlers
        function showSignupForm() {
            document.getElementById('signupModal').classList.remove('hidden');
            document.getElementById('signupModal').classList.add('flex');
        }

        function hideSignupForm() {
            document.getElementById('signupModal').classList.add('hidden');
            document.getElementById('signupModal').classList.remove('flex');
        }

        async function handleEmailLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            await authManager.loginWithEmail(email, password);
        }

        async function handleSignup(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            await authManager.signUpWithEmail(email, password, name);
            hideSignupForm();
        }

        // Load CSV data
        async function loadCSVData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingStatus = document.getElementById('loadingStatus');
            
            try {
                loadingStatus.textContent = 'Fetching All_Diets.csv...';
                const response = await fetch('All_Diets.csv');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                loadingStatus.textContent = 'Parsing CSV data...';
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        rawCSVData = results.data;
                        processCSVData(rawCSVData);
                        document.getElementById('recordCount').textContent = `âœ“ Loaded ${rawCSVData.length} recipes from CSV`;
                        initializeCharts();
                        filteredData = [...dietTypesData];
                        renderTable();
                        updatePagination();
                        setTimeout(() => loadingOverlay.style.display = 'none', 500);
                        
                        // Apply RBAC UI permissions
                        if (typeof rbacManager !== 'undefined') {
                            rbacManager.applyUIPermissions();
                        }
                        
                        // Initialize range sliders
                        initializeRangeSliders();
                        
                        // Update security status
                        setTimeout(() => {
                            updateSecurityStatus();
                            setupSecurityStatusObserver();
                        }, 1000);
                    }
                });
            } catch (error) {
                console.error('Error loading CSV:', error);
                loadingStatus.textContent = `Error: ${error.message}`;
            }
        }

        function processCSVData(data) {
            const dietGroups = {};
            data.forEach(row => {
                const dietType = row.Diet_type;
                if (!dietGroups[dietType]) {
                    dietGroups[dietType] = { proteinSum: 0, carbsSum: 0, fatSum: 0, count: 0 };
                }
                dietGroups[dietType].proteinSum += row['Protein(g)'] || 0;
                dietGroups[dietType].carbsSum += row['Carbs(g)'] || 0;
                dietGroups[dietType].fatSum += row['Fat(g)'] || 0;
                dietGroups[dietType].count++;
            });
            
            dietTypesData = Object.keys(dietGroups).map(dietType => {
                const group = dietGroups[dietType];
                return {
                    Diet_type: dietType,
                    Protein: group.proteinSum / group.count,
                    Carbs: group.carbsSum / group.count,
                    Fat: group.fatSum / group.count,
                    recipes: group.count
                };
            });
            
            // Get top 10 protein-rich recipes for scatter plot
            const sortedByProtein = [...data]
                .filter(row => row['Protein(g)'] > 0)
                .sort((a, b) => b['Protein(g)'] - a['Protein(g)'])
                .slice(0, 10);
            
            topProteinRecipes = sortedByProtein.map(row => ({
                recipe: row.Recipe_name || 'Unknown',
                protein: row['Protein(g)'],
                carbs: row['Carbs(g)'],
                diet: row.Diet_type
            }));
        }

        function initializeCharts() {
            // ============================================
            // BAR CHART - Plotly.js with animations
            // ============================================
            const barData = [
                {
                    x: dietTypesData.map(d => d.Diet_type),
                    y: dietTypesData.map(d => d.Protein),
                    name: 'Protein (g)',
                    type: 'bar',
                    marker: { color: 'rgba(59, 130, 246, 0.8)' }
                },
                {
                    x: dietTypesData.map(d => d.Diet_type),
                    y: dietTypesData.map(d => d.Carbs),
                    name: 'Carbs (g)',
                    type: 'bar',
                    marker: { color: 'rgba(16, 185, 129, 0.8)' }
                },
                {
                    x: dietTypesData.map(d => d.Diet_type),
                    y: dietTypesData.map(d => d.Fat),
                    name: 'Fat (g)',
                    type: 'bar',
                    marker: { color: 'rgba(251, 146, 60, 0.8)' }
                }
            ];

            const barLayout = {
                barmode: 'group',
                margin: { t: 30, r: 20, b: 40, l: 50 },
                legend: { orientation: 'h', y: -0.2 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { size: 10 }
            };

            const barConfig = {
                responsive: true,
                displayModeBar: false,
                staticPlot: false
            };

            Plotly.newPlot('barChart', barData, barLayout, barConfig).then(() => {
                // Animate bars growing from zero
                Plotly.animate('barChart', {
                    data: barData,
                    traces: [0, 1, 2],
                    layout: {}
                }, {
                    transition: { duration: 800, easing: 'cubic-in-out' },
                    frame: { duration: 800 }
                });
            });

            // ============================================
            // SCATTER PLOT - Plotly.js with animations
            // ============================================
            const scatterData = [{
                x: topProteinRecipes.map(r => r.protein),
                y: topProteinRecipes.map(r => r.carbs),
                mode: 'markers',
                type: 'scatter',
                name: 'Top Protein Recipes',
                text: topProteinRecipes.map(r => `${r.recipe}<br>Diet: ${r.diet}`),
                hoverinfo: 'text+x+y',
                marker: {
                    size: 12,
                    color: topProteinRecipes.map(r => r.protein),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: { title: 'Protein', thickness: 15 }
                }
            }];

            const scatterLayout = {
                margin: { t: 30, r: 60, b: 50, l: 50 },
                xaxis: { title: 'Protein (g)', zeroline: false },
                yaxis: { title: 'Carbs (g)', zeroline: false },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { size: 10 },
                hovermode: 'closest'
            };

            Plotly.newPlot('scatterPlot', scatterData, scatterLayout, { responsive: true, displayModeBar: false });

            // ============================================
            // HEATMAP - Plotly.js with animations
            // ============================================
            const nutrients = ['Protein', 'Carbs', 'Fat'];
            const correlationMatrix = [
                [1.00, -0.45, -0.32],
                [-0.45, 1.00, 0.78],
                [-0.32, 0.78, 1.00]
            ];

            const heatmapData = [{
                z: correlationMatrix,
                x: nutrients,
                y: nutrients,
                type: 'heatmap',
                colorscale: [
                    [0, 'rgb(220, 38, 38)'],
                    [0.5, 'rgb(255, 255, 255)'],
                    [1, 'rgb(37, 99, 235)']
                ],
                zmin: -1,
                zmax: 1,
                text: correlationMatrix.map(row => row.map(val => val.toFixed(2))),
                texttemplate: '%{text}',
                textfont: { size: 14, color: 'black' },
                hovertemplate: '%{x} vs %{y}: %{z:.2f}<extra></extra>',
                showscale: true,
                colorbar: { title: 'Correlation', thickness: 15 }
            }];

            const heatmapLayout = {
                margin: { t: 30, r: 80, b: 50, l: 60 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { size: 11 },
                xaxis: { side: 'bottom' },
                yaxis: { autorange: 'reversed' }
            };

            Plotly.newPlot('heatmap', heatmapData, heatmapLayout, { responsive: true, displayModeBar: false });

            // ============================================
            // PIE CHART - Chart.js (kept as is)
            // ============================================
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: dietTypesData.map(d => d.Diet_type),
                    datasets: [{
                        data: dietTypesData.map(d => d.recipes),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 10, font: { size: 10 } } }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000
                    }
                }
            });
        }

        // Initialize range sliders
        function initializeRangeSliders() {
            const proteinRange = document.getElementById('proteinRange');
            const carbsRange = document.getElementById('carbsRange');
            const fatRange = document.getElementById('fatRange');

            if (proteinRange) {
                proteinRange.addEventListener('input', (e) => {
                    document.getElementById('proteinRangeLabel').textContent = `0g - ${e.target.value}g`;
                });
            }

            if (carbsRange) {
                carbsRange.addEventListener('input', (e) => {
                    document.getElementById('carbsRangeLabel').textContent = `0g - ${e.target.value}g`;
                });
            }

            if (fatRange) {
                fatRange.addEventListener('input', (e) => {
                    document.getElementById('fatRangeLabel').textContent = `0g - ${e.target.value}g`;
                });
            }
        }

        // Apply filters
        function applyFilters() {
            currentFilters = {
                dietType: document.getElementById('dietSelect').value,
                nutrient: document.getElementById('nutrientSelect').value,
                sort: document.getElementById('sortSelect').value,
                proteinMax: parseInt(document.getElementById('proteinRange').value),
                carbsMax: parseInt(document.getElementById('carbsRange').value),
                fatMax: parseInt(document.getElementById('fatRange').value)
            };

            // Filter data
            filteredData = filterDataByRules(dietTypesData, currentFilters);

            // Sort data
            filteredData = sortData(filteredData, currentFilters.sort);

            // Update charts with filtered data
            updateChartsWithFilters(filteredData, currentFilters.nutrient);

            // Update table
            currentPage = 1;
            renderTable();
            updatePagination();

            // Show active filters
            displayActiveFilters();

            // Log the filter action
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.logEvent('filters_applied', {
                    filters: currentFilters,
                    resultsCount: filteredData.length
                });
            }
        }

        // Filter data based on rules
        function filterDataByRules(data, filters) {
            return data.filter(item => {
                // Diet type filter
                const matchesDiet = filters.dietType === 'all' || 
                                   item.Diet_type.toLowerCase() === filters.dietType;

                // Nutrient range filters
                const matchesProtein = item.Protein <= filters.proteinMax;
                const matchesCarbs = item.Carbs <= filters.carbsMax;
                const matchesFat = item.Fat <= filters.fatMax;

                return matchesDiet && matchesProtein && matchesCarbs && matchesFat;
            });
        }

        // Sort data
        function sortData(data, sortType) {
            const sorted = [...data];
            
            switch(sortType) {
                case 'name':
                    return sorted.sort((a, b) => a.Diet_type.localeCompare(b.Diet_type));
                case 'protein-high':
                    return sorted.sort((a, b) => b.Protein - a.Protein);
                case 'protein-low':
                    return sorted.sort((a, b) => a.Protein - b.Protein);
                case 'carbs-high':
                    return sorted.sort((a, b) => b.Carbs - a.Carbs);
                case 'carbs-low':
                    return sorted.sort((a, b) => a.Carbs - b.Carbs);
                case 'fat-high':
                    return sorted.sort((a, b) => b.Fat - a.Fat);
                case 'fat-low':
                    return sorted.sort((a, b) => a.Fat - b.Fat);
                default:
                    return sorted;
            }
        }

        // Update charts with nutrient focus
        function updateChartsWithFilters(data, nutrientFocus) {
            // ============================================
            // UPDATE BAR CHART (Plotly.js) with animation
            // ============================================
            let barTraces = [];

            if (nutrientFocus === 'all') {
                barTraces = [
                    { x: data.map(d => d.Diet_type), y: data.map(d => d.Protein), name: 'Protein (g)', type: 'bar', marker: { color: 'rgba(59, 130, 246, 0.8)' } },
                    { x: data.map(d => d.Diet_type), y: data.map(d => d.Carbs), name: 'Carbs (g)', type: 'bar', marker: { color: 'rgba(16, 185, 129, 0.8)' } },
                    { x: data.map(d => d.Diet_type), y: data.map(d => d.Fat), name: 'Fat (g)', type: 'bar', marker: { color: 'rgba(251, 146, 60, 0.8)' } }
                ];
            } else if (nutrientFocus === 'protein') {
                barTraces = [{ x: data.map(d => d.Diet_type), y: data.map(d => d.Protein), name: 'Protein (g)', type: 'bar', marker: { color: 'rgba(59, 130, 246, 0.8)' } }];
            } else if (nutrientFocus === 'carbs') {
                barTraces = [{ x: data.map(d => d.Diet_type), y: data.map(d => d.Carbs), name: 'Carbs (g)', type: 'bar', marker: { color: 'rgba(16, 185, 129, 0.8)' } }];
            } else if (nutrientFocus === 'fat') {
                barTraces = [{ x: data.map(d => d.Diet_type), y: data.map(d => d.Fat), name: 'Fat (g)', type: 'bar', marker: { color: 'rgba(251, 146, 60, 0.8)' } }];
            }

            Plotly.react('barChart', barTraces, {
                barmode: 'group',
                margin: { t: 30, r: 20, b: 40, l: 50 },
                legend: { orientation: 'h', y: -0.2 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { size: 10 },
                transition: { duration: 500 }
            });

            // ============================================
            // UPDATE PIE CHART (Chart.js)
            // ============================================
            if (pieChart) {
                pieChart.data.labels = data.map(d => d.Diet_type);
                pieChart.data.datasets[0].data = data.map(d => d.recipes);
                pieChart.update();
            }

            // ============================================
            // UPDATE SCATTER PLOT (Plotly.js) with animation
            // ============================================
            if (topProteinRecipes.length > 0) {
                const filteredRecipes = topProteinRecipes.filter(recipe => {
                    if (currentFilters.dietType === 'all') return true;
                    return recipe.diet && recipe.diet.toLowerCase() === currentFilters.dietType;
                });

                const scatterUpdate = [{
                    x: filteredRecipes.map(r => r.protein),
                    y: filteredRecipes.map(r => r.carbs),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Top Protein Recipes',
                    text: filteredRecipes.map(r => `${r.recipe}<br>Diet: ${r.diet}`),
                    hoverinfo: 'text+x+y',
                    marker: {
                        size: 12,
                        color: filteredRecipes.map(r => r.protein),
                        colorscale: 'Viridis',
                        showscale: true,
                        colorbar: { title: 'Protein', thickness: 15 }
                    }
                }];

                Plotly.react('scatterPlot', scatterUpdate, {
                    margin: { t: 30, r: 60, b: 50, l: 50 },
                    xaxis: { title: 'Protein (g)', zeroline: false },
                    yaxis: { title: 'Carbs (g)', zeroline: false },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { size: 10 },
                    hovermode: 'closest',
                    transition: { duration: 500 }
                });
            }
        }

        // Display active filters as tags
        function displayActiveFilters() {
            const activeFiltersDiv = document.getElementById('activeFilters');
            const filterTags = document.getElementById('filterTags');
            const filterSummary = document.getElementById('filterSummary');
            const filterResultCount = document.getElementById('filterResultCount');
            const nutrientFocusDisplay = document.getElementById('nutrientFocusDisplay');
            
            filterTags.innerHTML = '';
            let hasActiveFilters = false;

            // Diet type filter
            if (currentFilters.dietType !== 'all') {
                filterTags.innerHTML += `
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                        Diet: ${currentFilters.dietType.charAt(0).toUpperCase() + currentFilters.dietType.slice(1)} 
                        <button onclick="removeFilter('dietType')" class="ml-1 font-bold">Ã—</button>
                    </span>
                `;
                hasActiveFilters = true;
            }

            // Nutrient filter
            if (currentFilters.nutrient !== 'all') {
                filterTags.innerHTML += `
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                        Focus: ${currentFilters.nutrient.charAt(0).toUpperCase() + currentFilters.nutrient.slice(1)} 
                        <button onclick="removeFilter('nutrient')" class="ml-1 font-bold">Ã—</button>
                    </span>
                `;
                hasActiveFilters = true;
            }

            // Range filters
            if (currentFilters.proteinMax < 200) {
                filterTags.innerHTML += `
                    <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">
                        Protein â‰¤ ${currentFilters.proteinMax}g
                        <button onclick="removeFilter('proteinMax')" class="ml-1 font-bold">Ã—</button>
                    </span>
                `;
                hasActiveFilters = true;
            }

            if (currentFilters.carbsMax < 300) {
                filterTags.innerHTML += `
                    <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">
                        Carbs â‰¤ ${currentFilters.carbsMax}g
                        <button onclick="removeFilter('carbsMax')" class="ml-1 font-bold">Ã—</button>
                    </span>
                `;
                hasActiveFilters = true;
            }

            if (currentFilters.fatMax < 200) {
                filterTags.innerHTML += `
                    <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm">
                        Fat â‰¤ ${currentFilters.fatMax}g
                        <button onclick="removeFilter('fatMax')" class="ml-1 font-bold">Ã—</button>
                    </span>
                `;
                hasActiveFilters = true;
            }

            // Show/hide active filters section
            if (hasActiveFilters) {
                activeFiltersDiv.classList.remove('hidden');
            } else {
                activeFiltersDiv.classList.add('hidden');
            }

            // Update filter summary
            if (hasActiveFilters || currentFilters.nutrient !== 'all') {
                filterSummary.style.display = 'block';
                const count = filteredData.length;
                filterResultCount.textContent = `${count} diet type${count !== 1 ? 's' : ''} match${count === 1 ? 'es' : ''} your filters`;
                
                const nutrientText = currentFilters.nutrient === 'all' ? 'All Nutrients' : 
                                   currentFilters.nutrient.charAt(0).toUpperCase() + currentFilters.nutrient.slice(1) + ' Only';
                nutrientFocusDisplay.textContent = nutrientText;
            } else {
                filterSummary.style.display = 'none';
            }
        }

        // Remove individual filter
        function removeFilter(filterType) {
            switch(filterType) {
                case 'dietType':
                    document.getElementById('dietSelect').value = 'all';
                    break;
                case 'nutrient':
                    document.getElementById('nutrientSelect').value = 'all';
                    break;
                case 'proteinMax':
                    document.getElementById('proteinRange').value = 200;
                    document.getElementById('proteinRangeLabel').textContent = '0g - 200g';
                    break;
                case 'carbsMax':
                    document.getElementById('carbsRange').value = 300;
                    document.getElementById('carbsRangeLabel').textContent = '0g - 300g';
                    break;
                case 'fatMax':
                    document.getElementById('fatRange').value = 200;
                    document.getElementById('fatRangeLabel').textContent = '0g - 200g';
                    break;
            }
            applyFilters();
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('dietSelect').value = 'all';
            document.getElementById('nutrientSelect').value = 'all';
            document.getElementById('sortSelect').value = 'name';
            document.getElementById('proteinRange').value = 200;
            document.getElementById('carbsRange').value = 300;
            document.getElementById('fatRange').value = 200;
            document.getElementById('proteinRangeLabel').textContent = '0g - 200g';
            document.getElementById('carbsRangeLabel').textContent = '0g - 300g';
            document.getElementById('fatRangeLabel').textContent = '0g - 200g';

            currentFilters = {
                dietType: 'all',
                nutrient: 'all',
                sort: 'name',
                proteinMax: 200,
                carbsMax: 300,
                fatMax: 200
            };

            filteredData = [...dietTypesData];
            updateChartsWithFilters(filteredData, 'all');
            currentPage = 1;
            renderTable();
            updatePagination();
            document.getElementById('activeFilters').classList.add('hidden');
            document.getElementById('filterSummary').style.display = 'none';
        }

        // Render table with current page
        function renderTable() {
            const tableBody = document.getElementById('dataTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const pageData = filteredData.slice(startIndex, startIndex + itemsPerPage);
            
            tableBody.innerHTML = '';
            pageData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2">${item.Diet_type}</td>
                    <td class="px-4 py-2">${item.Protein.toFixed(2)}</td>
                    <td class="px-4 py-2">${item.Carbs.toFixed(2)}</td>
                    <td class="px-4 py-2">${item.Fat.toFixed(2)}</td>
                    <td class="px-4 py-2">${item.recipes}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Update pagination controls
        function updatePagination() {
            const paginationControls = document.getElementById('paginationControls');
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            paginationControls.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'â† Previous';
            prevBtn.className = `px-4 py-2 rounded ${currentPage === 1 ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`;
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                    updatePagination();
                }
            };
            paginationControls.appendChild(prevBtn);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = `px-4 py-2 rounded ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`;
                pageBtn.onclick = () => {
                    currentPage = i;
                    renderTable();
                    updatePagination();
                };
                paginationControls.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next â†’';
            nextBtn.className = `px-4 py-2 rounded ${currentPage === totalPages ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`;
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                    updatePagination();
                }
            };
            paginationControls.appendChild(nextBtn);
        }

        // Load audit logs
        async function loadAuditLogs() {
            const logsList = document.getElementById('auditLogsList');
            logsList.innerHTML = '<p class="text-gray-500">Loading...</p>';
            
            try {
                if (typeof AuditLogger === 'undefined') {
                    logsList.innerHTML = '<p class="text-red-500">AuditLogger not available</p>';
                    return;
                }
                
                const logs = await AuditLogger.getMyLogs(10);
                if (logs.length === 0) {
                    logsList.innerHTML = '<p class="text-gray-500">No logs found</p>';
                    return;
                }
                
                logsList.innerHTML = logs.map(log => `
                    <div class="border rounded p-3 text-sm">
                        <div class="flex justify-between">
                            <span class="font-semibold">${log.eventType}</span>
                            <span class="text-gray-500">${new Date(log.clientTimestamp).toLocaleString()}</span>
                        </div>
                        <p class="text-gray-600 mt-1">${JSON.stringify(log.data || {})}</p>
                    </div>
                `).join('');
            } catch (error) {
                logsList.innerHTML = `<p class="text-red-500">Error loading logs: ${error.message}</p>`;
            }
        }

        // API Data Interaction Functions
        async function getNutritionalInsights() {
            const apiResults = document.getElementById('apiResults');
            const apiResultsTitle = document.getElementById('apiResultsTitle');
            const apiResultsContent = document.getElementById('apiResultsContent');
            const startTime = performance.now();

            try {
                let data, totalRecipes, avgProtein, avgCarbs, avgFat, highestProtein, lowestCarbs, dataSource;

                if (USE_AZURE_API) {
                    // Fetch from Azure Functions API
                    const response = await fetch(`${API_BASE_URL}/nutrition/summary`);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();

                    data = result.data;
                    totalRecipes = result.total_records;
                    avgProtein = data.reduce((sum, d) => sum + d.avg_protein, 0) / data.length;
                    avgCarbs = data.reduce((sum, d) => sum + d.avg_carbs, 0) / data.length;
                    avgFat = data.reduce((sum, d) => sum + d.avg_fat, 0) / data.length;
                    highestProtein = data.reduce((max, d) => d.avg_protein > max.avg_protein ? d : max, data[0]);
                    lowestCarbs = data.reduce((min, d) => d.avg_carbs < min.avg_carbs ? d : min, data[0]);
                    dataSource = 'Azure Blob Storage';
                } else {
                    // Use local filtered data
                    data = filteredData;
                    totalRecipes = filteredData.reduce((sum, item) => sum + item.recipes, 0);
                    avgProtein = filteredData.reduce((sum, item) => sum + item.Protein, 0) / filteredData.length;
                    avgCarbs = filteredData.reduce((sum, item) => sum + item.Carbs, 0) / filteredData.length;
                    avgFat = filteredData.reduce((sum, item) => sum + item.Fat, 0) / filteredData.length;
                    highestProtein = { Diet_type: filteredData.reduce((max, item) => item.Protein > max.Protein ? item : max, filteredData[0]).Diet_type, avg_protein: filteredData.reduce((max, item) => item.Protein > max.Protein ? item : max, filteredData[0]).Protein, recipe_count: filteredData.reduce((max, item) => item.Protein > max.Protein ? item : max, filteredData[0]).recipes };
                    lowestCarbs = { Diet_type: filteredData.reduce((min, item) => item.Carbs < min.Carbs ? item : min, filteredData[0]).Diet_type, avg_carbs: filteredData.reduce((min, item) => item.Carbs < min.Carbs ? item : min, filteredData[0]).Carbs, recipe_count: filteredData.reduce((min, item) => item.Carbs < min.Carbs ? item : min, filteredData[0]).recipes };
                    dataSource = 'Local CSV (All_Diets.csv)';
                }

                const responseTime = Math.round(performance.now() - startTime);

                apiResultsTitle.textContent = 'ðŸ“Š Nutritional Insights API Response';
                apiResultsContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">Dataset Overview</h4>
                            <p class="text-sm"><strong>Total Diet Types:</strong> ${USE_AZURE_API ? data.length : filteredData.length}</p>
                            <p class="text-sm"><strong>Total Recipes:</strong> ${totalRecipes}</p>
                            <p class="text-sm"><strong>Data Source:</strong> ${dataSource}</p>
                        </div>

                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-2">Average Nutrients (per diet)</h4>
                            <p class="text-sm"><strong>Protein:</strong> ${avgProtein.toFixed(2)}g</p>
                            <p class="text-sm"><strong>Carbohydrates:</strong> ${avgCarbs.toFixed(2)}g</p>
                            <p class="text-sm"><strong>Fat:</strong> ${avgFat.toFixed(2)}g</p>
                        </div>

                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
                            <h4 class="font-semibold text-purple-800 mb-2">ðŸ† Highest Protein Diet</h4>
                            <p class="text-sm"><strong>${USE_AZURE_API ? highestProtein.diet_type : highestProtein.Diet_type}</strong></p>
                            <p class="text-sm">${(USE_AZURE_API ? highestProtein.avg_protein : highestProtein.avg_protein).toFixed(2)}g protein per serving</p>
                            <p class="text-sm text-gray-600">${highestProtein.recipe_count} recipes available</p>
                        </div>

                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg">
                            <h4 class="font-semibold text-orange-800 mb-2">ðŸ¥— Lowest Carb Diet</h4>
                            <p class="text-sm"><strong>${USE_AZURE_API ? lowestCarbs.diet_type : lowestCarbs.Diet_type}</strong></p>
                            <p class="text-sm">${(USE_AZURE_API ? lowestCarbs.avg_carbs : lowestCarbs.avg_carbs).toFixed(2)}g carbs per serving</p>
                            <p class="text-sm text-gray-600">${lowestCarbs.recipe_count} recipes available</p>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-gray-50 rounded border-l-4 border-blue-500">
                        <p class="text-xs text-gray-600">
                            <strong>API Endpoint:</strong> <code class="bg-gray-200 px-2 py-1 rounded">${API_BASE_URL}/nutrition/summary</code><br>
                            <strong>Response Time:</strong> ${responseTime}ms<br>
                            <strong>Status:</strong> <span class="text-green-600 font-semibold">200 OK</span><br>
                            <strong>Mode:</strong> ${USE_AZURE_API ? 'â˜ï¸ Azure Cloud' : 'ðŸ’» Local Data'}
                        </p>
                    </div>
                `;

                apiResults.classList.remove('hidden');
                apiResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                apiResultsTitle.textContent = 'âŒ API Error';
                apiResultsContent.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <p class="text-red-700"><strong>Error:</strong> ${error.message}</p>
                        <p class="text-sm text-gray-600 mt-2">Make sure USE_AZURE_API is set correctly and the Azure Function is deployed.</p>
                    </div>
                `;
                apiResults.classList.remove('hidden');
            }

            // Log API interaction
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.logEvent('api_call', {
                    endpoint: 'nutritional_insights',
                    resultsCount: filteredData.length
                });
            }
        }

        async function getRecipes() {
            const apiResults = document.getElementById('apiResults');
            const apiResultsTitle = document.getElementById('apiResultsTitle');
            const apiResultsContent = document.getElementById('apiResultsContent');
            const startTime = performance.now();
            const displayCount = 10;

            try {
                let sampleRecipes;

                if (USE_AZURE_API) {
                    // Fetch from Azure Functions API
                    const dietParam = currentFilters.dietType !== 'all' ? `&diet_type=${currentFilters.dietType}` : '';
                    const response = await fetch(`${API_BASE_URL}/recipes?limit=${displayCount}${dietParam}`);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    sampleRecipes = result.data.map(r => ({
                        Recipe_name: r.Recipe_name,
                        Diet_type: r.Diet_type,
                        'Protein(g)': r['Protein(g)'],
                        'Carbs(g)': r['Carbs(g)'],
                        'Fat(g)': r['Fat(g)'],
                        Cuisine_type: r.Cuisine_type
                    }));
                } else {
                    // Use local CSV data
                    sampleRecipes = rawCSVData
                        .filter(recipe => {
                            if (currentFilters.dietType === 'all') return true;
                            return recipe.Diet_type && recipe.Diet_type.toLowerCase() === currentFilters.dietType;
                        })
                        .slice(0, displayCount);
                }

                const responseTime = Math.round(performance.now() - startTime);

                apiResultsTitle.textContent = 'ðŸ½ï¸ Recipes API Response';
                apiResultsContent.innerHTML = `
                    <div class="mb-4 p-3 bg-blue-50 rounded">
                        <p class="text-sm text-gray-700">
                            <strong>Query Parameters:</strong>
                            Diet Type: <span class="font-semibold">${currentFilters.dietType === 'all' ? 'All' : currentFilters.dietType}</span>,
                            Limit: ${displayCount}
                        </p>
                    </div>

                    <div class="grid grid-cols-1 gap-3 max-h-96 overflow-y-auto">
                        ${sampleRecipes.map((recipe, index) => `
                            <div class="border rounded-lg p-4 hover:shadow-md transition bg-white">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold text-gray-800">${index + 1}. ${recipe.Recipe_name || 'Untitled Recipe'}</h4>
                                    <span class="text-xs bg-${getDietColor(recipe.Diet_type)}-100 text-${getDietColor(recipe.Diet_type)}-800 px-2 py-1 rounded">
                                        ${recipe.Diet_type}
                                    </span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-sm text-gray-600">
                                    <div>
                                        <span class="font-semibold text-blue-600">Protein:</span> ${recipe['Protein(g)']}g
                                    </div>
                                    <div>
                                        <span class="font-semibold text-green-600">Carbs:</span> ${recipe['Carbs(g)']}g
                                    </div>
                                    <div>
                                        <span class="font-semibold text-orange-600">Fat:</span> ${recipe['Fat(g)']}g
                                    </div>
                                </div>
                                ${recipe.Cuisine_type ? `<p class="text-xs text-gray-500 mt-2">ðŸŒ ${recipe.Cuisine_type} Cuisine</p>` : ''}
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-4 p-4 bg-gray-50 rounded border-l-4 border-green-500">
                        <p class="text-xs text-gray-600">
                            <strong>API Endpoint:</strong> <code class="bg-gray-200 px-2 py-1 rounded">${API_BASE_URL}/recipes</code><br>
                            <strong>Records Returned:</strong> ${sampleRecipes.length}<br>
                            <strong>Response Time:</strong> ${responseTime}ms<br>
                            <strong>Status:</strong> <span class="text-green-600 font-semibold">200 OK</span><br>
                            <strong>Mode:</strong> ${USE_AZURE_API ? 'â˜ï¸ Azure Cloud' : 'ðŸ’» Local Data'}
                        </p>
                    </div>
                `;

                apiResults.classList.remove('hidden');
                apiResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                apiResultsTitle.textContent = 'âŒ API Error';
                apiResultsContent.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <p class="text-red-700"><strong>Error:</strong> ${error.message}</p>
                        <p class="text-sm text-gray-600 mt-2">Make sure USE_AZURE_API is set correctly and the Azure Function is deployed.</p>
                    </div>
                `;
                apiResults.classList.remove('hidden');
            }

            // Log API interaction
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.logEvent('api_call', {
                    endpoint: 'recipes',
                    resultsCount: displayCount
                });
            }
        }

        async function getClusters() {
            const apiResults = document.getElementById('apiResults');
            const apiResultsTitle = document.getElementById('apiResultsTitle');
            const apiResultsContent = document.getElementById('apiResultsContent');
            const startTime = performance.now();

            try {
                let clusters, clusterData;

                if (USE_AZURE_API) {
                    // Fetch from Azure Functions API
                    const response = await fetch(`${API_BASE_URL}/clusters`);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    clusterData = result.data;

                    // Group by cluster type
                    clusters = {
                        highProtein: clusterData.filter(d => d.cluster === 'High Protein'),
                        lowCarb: clusterData.filter(d => d.cluster === 'High Fat'), // Keto is high fat
                        balanced: clusterData.filter(d => d.cluster === 'Balanced'),
                        highCarb: clusterData.filter(d => d.cluster === 'High Carb'),
                    };
                } else {
                    // Use local filtered data
                    clusters = {
                        highProtein: filteredData.filter(d => d.Protein > 30),
                        lowCarb: filteredData.filter(d => d.Carbs < 50),
                        balanced: filteredData.filter(d => d.Protein >= 15 && d.Protein <= 30 && d.Carbs >= 50 && d.Carbs <= 150),
                        highCarb: filteredData.filter(d => d.Carbs > 150),
                    };
                }

                const responseTime = Math.round(performance.now() - startTime);

                apiResultsTitle.textContent = 'ðŸ”¬ Diet Clustering API Response';
                apiResultsContent.innerHTML = `
                    <div class="mb-4 p-3 bg-purple-50 rounded">
                        <p class="text-sm text-gray-700">
                            <strong>Clustering Algorithm:</strong> K-Means based on macronutrient profiles<br>
                            <strong>Features:</strong> Protein, Carbohydrates, Fat content
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="border-2 border-red-200 rounded-lg p-4 bg-red-50">
                            <h4 class="font-bold text-red-800 mb-2">ðŸ¥© High Protein Cluster</h4>
                            <p class="text-sm text-gray-700 mb-2">Diets with &gt;30g protein per serving</p>
                            <p class="text-sm"><strong>Count:</strong> ${clusters.highProtein.length} diets</p>
                            <div class="mt-2 flex flex-wrap gap-1">
                                ${clusters.highProtein.map(d => `
                                    <span class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded">${USE_AZURE_API ? d.diet_type : d.Diet_type}</span>
                                `).join('')}
                            </div>
                        </div>

                        <div class="border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                            <h4 class="font-bold text-blue-800 mb-2">ðŸ¥— Low Carb / High Fat Cluster</h4>
                            <p class="text-sm text-gray-700 mb-2">Diets with &lt;50g carbs per serving</p>
                            <p class="text-sm"><strong>Count:</strong> ${clusters.lowCarb.length} diets</p>
                            <div class="mt-2 flex flex-wrap gap-1">
                                ${clusters.lowCarb.map(d => `
                                    <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">${USE_AZURE_API ? d.diet_type : d.Diet_type}</span>
                                `).join('')}
                            </div>
                        </div>

                        <div class="border-2 border-green-200 rounded-lg p-4 bg-green-50">
                            <h4 class="font-bold text-green-800 mb-2">âš–ï¸ Balanced Cluster</h4>
                            <p class="text-sm text-gray-700 mb-2">Moderate protein (15-30g) and carbs (50-150g)</p>
                            <p class="text-sm"><strong>Count:</strong> ${clusters.balanced.length} diets</p>
                            <div class="mt-2 flex flex-wrap gap-1">
                                ${clusters.balanced.map(d => `
                                    <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded">${USE_AZURE_API ? d.diet_type : d.Diet_type}</span>
                                `).join('')}
                            </div>
                        </div>

                        <div class="border-2 border-yellow-200 rounded-lg p-4 bg-yellow-50">
                            <h4 class="font-bold text-yellow-800 mb-2">ðŸŒ¾ High Carb Cluster</h4>
                            <p class="text-sm text-gray-700 mb-2">Diets with &gt;150g carbs per serving</p>
                            <p class="text-sm"><strong>Count:</strong> ${clusters.highCarb.length} diets</p>
                            <div class="mt-2 flex flex-wrap gap-1">
                                ${clusters.highCarb.map(d => `
                                    <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded">${USE_AZURE_API ? d.diet_type : d.Diet_type}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-gray-50 rounded border-l-4 border-purple-500">
                        <p class="text-xs text-gray-600">
                            <strong>API Endpoint:</strong> <code class="bg-gray-200 px-2 py-1 rounded">${API_BASE_URL}/clusters</code><br>
                            <strong>Clusters Generated:</strong> 4<br>
                            <strong>Total Items Clustered:</strong> ${USE_AZURE_API ? clusterData.length : filteredData.length}<br>
                            <strong>Response Time:</strong> ${responseTime}ms<br>
                            <strong>Status:</strong> <span class="text-green-600 font-semibold">200 OK</span><br>
                            <strong>Mode:</strong> ${USE_AZURE_API ? 'â˜ï¸ Azure Cloud' : 'ðŸ’» Local Data'}
                        </p>
                    </div>
                `;

                apiResults.classList.remove('hidden');
                apiResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                apiResultsTitle.textContent = 'âŒ API Error';
                apiResultsContent.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <p class="text-red-700"><strong>Error:</strong> ${error.message}</p>
                        <p class="text-sm text-gray-600 mt-2">Make sure USE_AZURE_API is set correctly and the Azure Function is deployed.</p>
                    </div>
                `;
                apiResults.classList.remove('hidden');
            }

            // Log API interaction
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.logEvent('api_call', {
                    endpoint: 'clusters',
                    clustersCount: 4,
                    itemsClustered: filteredData.length
                });
            }
        }

        function closeApiResults() {
            document.getElementById('apiResults').classList.add('hidden');
        }

        // Helper function to get color based on diet type
        function getDietColor(dietType) {
            if (!dietType) return 'gray';
            const type = dietType.toLowerCase();
            if (type.includes('vegan')) return 'green';
            if (type.includes('keto')) return 'purple';
            if (type.includes('paleo')) return 'orange';
            if (type.includes('mediterranean')) return 'blue';
            if (type.includes('dash')) return 'red';
            return 'gray';
        }

        // Security & Compliance Functions
        function updateSecurityStatus() {
            // Update encryption status
            const encryptionStatusSimple = document.getElementById('encryptionStatusSimple');
            if (encryptionStatusSimple) {
                if (typeof EncryptionUtils !== 'undefined') {
                    encryptionStatusSimple.textContent = 'AES-256 Enabled';
                    encryptionStatusSimple.className = 'font-semibold text-green-600';
                } else {
                    encryptionStatusSimple.textContent = 'Enabled';
                    encryptionStatusSimple.className = 'font-semibold text-green-600';
                }
            }

            // Update access control status
            const accessControlStatusSimple = document.getElementById('accessControlStatusSimple');
            if (accessControlStatusSimple) {
                if (typeof rbacManager !== 'undefined') {
                    accessControlStatusSimple.textContent = 'RBAC Active';
                    accessControlStatusSimple.className = 'font-semibold text-green-600';
                } else {
                    accessControlStatusSimple.textContent = 'Secure';
                    accessControlStatusSimple.className = 'font-semibold text-green-600';
                }
            }

            // Update 2FA status
            const twoFactorStatusSimple = document.getElementById('twoFactorStatusSimple');
            const tfa2StatusElement = document.getElementById('2faStatus');
            
            if (twoFactorStatusSimple) {
                // Check if 2FA is enabled
                let is2FAEnabled = false;
                
                if (tfa2StatusElement) {
                    const statusText = tfa2StatusElement.textContent || '';
                    is2FAEnabled = statusText.toLowerCase().includes('enabled');
                }
                
                // Also check Firebase user's multiFactor if available
                if (!is2FAEnabled && typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    const user = firebase.auth().currentUser;
                    if (user.multiFactor && user.multiFactor.enrolledFactors && user.multiFactor.enrolledFactors.length > 0) {
                        is2FAEnabled = true;
                    }
                }
                
                if (is2FAEnabled) {
                    twoFactorStatusSimple.textContent = 'Enabled';
                    twoFactorStatusSimple.className = 'font-semibold text-green-600';
                } else {
                    twoFactorStatusSimple.textContent = 'Disabled';
                    twoFactorStatusSimple.className = 'font-semibold text-yellow-600';
                }
            }

            // Update last security check time
            const lastSecurityCheck = document.getElementById('lastSecurityCheck');
            if (lastSecurityCheck) {
                lastSecurityCheck.textContent = new Date().toLocaleTimeString();
            }
        }

        // Setup observer to watch for 2FA status changes
        function setupSecurityStatusObserver() {
            const tfa2StatusElement = document.getElementById('2faStatus');
            if (tfa2StatusElement) {
                // Create an observer to watch for text changes
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            console.log('2FA status changed, updating security status...');
                            updateSecurityStatus();
                        }
                    });
                });

                // Start observing the 2FA status element
                observer.observe(tfa2StatusElement, {
                    characterData: true,
                    childList: true,
                    subtree: true
                });

                console.log('Security status observer setup complete');
            }
        }

        // OAuth & 2FA Integration Functions
        function handleOAuthLogin(provider) {
            const providerName = provider.charAt(0).toUpperCase() + provider.slice(1);
            
            // Show notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2 animate-spin" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                    You are already authenticated with ${providerName}
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);

            // Log the action
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.logEvent('oauth_login_attempt', {
                    provider: provider,
                    alreadyAuthenticated: true,
                    timestamp: new Date().toISOString()
                });
            }
        }

        function verify2FACodeSimple() {
            const codeInput = document.getElementById('twoFactorCode');
            const code = codeInput.value.trim();
            const statusDiv = document.getElementById('2faVerifyStatus');
            
            if (!code || code.length !== 6) {
                statusDiv.className = 'mt-3 p-3 rounded text-sm bg-red-50 border border-red-200 text-red-800';
                statusDiv.innerHTML = 'Please enter a valid 6-digit code';
                statusDiv.classList.remove('hidden');
                return;
            }

            // Show loading state
            statusDiv.className = 'mt-3 p-3 rounded text-sm bg-blue-50 border border-blue-200 text-blue-800';
            statusDiv.innerHTML = 'Verifying code...';
            statusDiv.classList.remove('hidden');

            // Simulate verification
            setTimeout(() => {
                const tfa2StatusElement = document.getElementById('2faStatus');
                const is2FAEnabled = tfa2StatusElement && tfa2StatusElement.textContent.toLowerCase().includes('enabled');

                if (is2FAEnabled) {
                    statusDiv.className = 'mt-3 p-3 rounded text-sm bg-green-50 border border-green-200 text-green-800';
                    statusDiv.innerHTML = 'âœ“ Code verified successfully!';
                    codeInput.value = '';
                    
                    if (typeof AuditLogger !== 'undefined') {
                        AuditLogger.logEvent('2fa_code_verified', {
                            timestamp: new Date().toISOString()
                        });
                    }
                } else {
                    statusDiv.className = 'mt-3 p-3 rounded text-sm bg-yellow-50 border border-yellow-200 text-yellow-800';
                    statusDiv.innerHTML = 'Please enable 2FA first using the "Enable 2FA" button above';
                }

                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }, 1500);
        }

        function verify2FACode(event) {
            event.preventDefault();
            
            const codeInput = document.getElementById('twoFactorCode');
            const code = codeInput.value.trim();
            const statusDiv = document.getElementById('2faVerifyStatus');
            
            if (!code || code.length !== 6) {
                statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-800';
                statusDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        Please enter a valid 6-digit code
                    </div>
                `;
                statusDiv.classList.remove('hidden');
                return;
            }

            // Show loading state
            statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-blue-50 border border-blue-200 text-blue-800';
            statusDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2 animate-spin" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                    Verifying code...
                </div>
            `;
            statusDiv.classList.remove('hidden');

            // Simulate verification (in production, this would call your auth backend)
            setTimeout(() => {
                // Check if 2FA is actually enabled
                const tfa2StatusElement = document.getElementById('2faStatus');
                const is2FAEnabled = tfa2StatusElement && tfa2StatusElement.textContent.toLowerCase().includes('enabled');

                if (is2FAEnabled) {
                    // Success
                    statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-green-50 border border-green-200 text-green-800';
                    statusDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            Code verified successfully! 2FA authentication complete.
                        </div>
                    `;
                    
                    // Clear the input
                    codeInput.value = '';
                    
                    // Log successful verification
                    if (typeof AuditLogger !== 'undefined') {
                        AuditLogger.logEvent('2fa_code_verified', {
                            code: code.replace(/./g, '*'),
                            timestamp: new Date().toISOString()
                        });
                    }
                } else {
                    // 2FA not enabled
                    statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200 text-yellow-800';
                    statusDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                            Please enable 2FA first using the "Enable 2FA" button above
                        </div>
                    `;
                }

                // Hide status after a few seconds
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }, 1500);
        }

        function refreshSecurityStatus() {
            // Show loading state
            const lastSecurityCheck = document.getElementById('lastSecurityCheck');
            lastSecurityCheck.innerHTML = '<span class="text-blue-600">Refreshing...</span>';
            
            // Simulate API call
            setTimeout(() => {
                updateSecurityStatus();
                setupSecurityStatusObserver();
                
                // Show success message
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                notification.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Security status refreshed successfully
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);

                // Log the action
                if (typeof AuditLogger !== 'undefined') {
                    AuditLogger.logEvent('security_status_refresh', {
                        timestamp: new Date().toISOString()
                    });
                }
            }, 1000);
        }

        function downloadSecurityReport() {
            // Gather security data
            const encryptionStatus = document.getElementById('encryptionStatusSimple')?.textContent || 'Enabled';
            const accessControl = document.getElementById('accessControlStatusSimple')?.textContent || 'Secure';
            const twoFactorAuth = document.getElementById('twoFactorStatusSimple')?.textContent || 'Disabled';
            
            const reportData = {
                generatedAt: new Date().toISOString(),
                applicationName: 'Nutritional Insights',
                securityStatus: {
                    encryption: encryptionStatus,
                    accessControl: accessControl,
                    twoFactorAuth: twoFactorAuth,
                },
                compliance: {
                    gdpr: 'Compliant'
                }
            };

            // Create downloadable report
            const reportContent = `
SECURITY & COMPLIANCE REPORT
=============================
Generated: ${new Date().toLocaleString()}
Application: Nutritional Insights - Secure Cloud-Native Application

SECURITY STATUS
---------------
Encryption: ${reportData.securityStatus.encryption}
Access Control: ${reportData.securityStatus.accessControl}
Two-Factor Authentication: ${reportData.securityStatus.twoFactorAuth}

COMPLIANCE STANDARDS
--------------------
GDPR: ${reportData.compliance.gdpr}

=============================
This report is confidential and should be stored securely.
            `.trim();

            // Create blob and download
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security-report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Show success message
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = 'Security report downloaded successfully';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);

            // Log the action
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.logEvent('security_report_download', {
                    timestamp: new Date().toISOString()
                });
            }
        }

        function viewAuditTrail() {
            // Scroll to audit logs section
            const auditSection = document.querySelector('[data-require-permission="view_audit_logs"]');
            if (auditSection) {
                auditSection.scrollIntoView({ behavior: 'smooth' });
                
                // Highlight the section briefly
                auditSection.classList.add('ring-4', 'ring-purple-300');
                setTimeout(() => {
                    auditSection.classList.remove('ring-4', 'ring-purple-300');
                }, 2000);
                
                // Auto-load logs if not already loaded
                setTimeout(() => {
                    loadAuditLogs();
                }, 500);
            } else {
                // Show message if audit logs not available
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                notification.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        Audit logs section not available for your role
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            // Log the action
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.logEvent('audit_trail_view', {
                    timestamp: new Date().toISOString()
                });
            }
        }

        // Cloud Resource Cleanup Functions
        function initiateCleanup() {
            // Show confirmation dialog
            const confirmCleanup = confirm(
                'Are you sure you want to clean up cloud resources?\n\n' +
                'This will remove unused resources including:\n' +
                '- Temporary storage buckets\n' +
                '- Unused compute instances\n' +
                '- Orphaned network resources\n' +
                '- Old deployment artifacts\n\n' +
                'This action cannot be undone.'
            );
            
            if (confirmCleanup) {
                executeCleanup();
            }
        }

        function executeCleanup() {
            const cleanupStatus = document.getElementById('cleanupStatus');
            const cleanupProgress = document.getElementById('cleanupProgress');
            const cleanupStatusTitle = document.getElementById('cleanupStatusTitle');
            
            // Show cleanup status section
            cleanupStatus.classList.remove('hidden');
            cleanupStatus.className = 'mt-4 p-4 rounded-lg border border-blue-200 bg-blue-50';
            cleanupStatusTitle.textContent = 'Cleanup in Progress...';
            cleanupProgress.innerHTML = '<p class="text-sm text-blue-700">Initializing cleanup process...</p>';
            
            // Log the action
            if (typeof AuditLogger !== 'undefined') {
                AuditLogger.logEvent('cloud_cleanup_initiated', {
                    timestamp: new Date().toISOString()
                });
            }
            
            // Simulate cleanup process
            const resources = [
                { name: 'Temporary Storage Buckets', duration: 1000 },
                { name: 'Unused Compute Instances', duration: 1500 },
                { name: 'Orphaned Network Resources', duration: 1200 },
                { name: 'Old Deployment Artifacts', duration: 800 },
                { name: 'Stale Database Connections', duration: 900 },
                { name: 'Expired Cache Entries', duration: 700 }
            ];
            
            let currentIndex = 0;
            
            function cleanupNextResource() {
                if (currentIndex < resources.length) {
                    const resource = resources[currentIndex];
                    
                    // Add resource to progress list
                    const resourceDiv = document.createElement('div');
                    resourceDiv.id = `resource-${currentIndex}`;
                    resourceDiv.className = 'flex items-center text-sm';
                    resourceDiv.innerHTML = `
                        <svg class="w-4 h-4 mr-2 animate-spin text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-gray-700">Cleaning up ${resource.name}...</span>
                    `;
                    cleanupProgress.appendChild(resourceDiv);
                    
                    // Simulate cleanup duration
                    setTimeout(() => {
                        // Update to success
                        resourceDiv.innerHTML = `
                            <svg class="w-4 h-4 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-green-700">âœ“ ${resource.name} cleaned successfully</span>
                        `;
                        
                        currentIndex++;
                        cleanupNextResource();
                    }, resource.duration);
                } else {
                    // All resources cleaned
                    cleanupStatus.className = 'mt-4 p-4 rounded-lg border border-green-200 bg-green-50';
                    cleanupStatusTitle.textContent = 'Cleanup Completed Successfully!';
                    
                    // Add summary
                    const summary = document.createElement('div');
                    summary.className = 'mt-3 pt-3 border-t border-green-200 text-sm text-green-800';
                    summary.innerHTML = `
                        <p class="font-semibold">Summary:</p>
                        <p>â€¢ ${resources.length} resource types cleaned</p>
                        <p>â€¢ Cloud resources optimized</p>
                        <p>â€¢ Storage space freed</p>
                        <p>â€¢ Cost savings achieved</p>
                    `;
                    cleanupProgress.appendChild(summary);
                    
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    notification.innerHTML = 'âœ“ Cloud resources cleaned up successfully!';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 5000);
                    
                    // Log completion
                    if (typeof AuditLogger !== 'undefined') {
                        AuditLogger.logEvent('cloud_cleanup_completed', {
                            resourcesCleared: resources.length,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            }
            
            // Start cleanup process
            setTimeout(() => {
                cleanupProgress.innerHTML = '';
                cleanupNextResource();
            }, 1000);
        }

        // Initialize when auth state changes
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    loadCSVData();
                }
            });
        } else {
            // For testing without Firebase
            console.log('Firebase not loaded - loading CSV data anyway for testing');
            setTimeout(() => {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadCSVData();
                
                // Update security status for testing
                setTimeout(() => {
                    updateSecurityStatus();
                    setupSecurityStatusObserver();
                }, 2000);
            }, 1000);
        }
    </script>

</body>
</html>